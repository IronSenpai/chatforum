{"version":3,"sources":["public/src/admin/extend/widgets.js"],"names":["define","Widgets","init","$","on","ev","$this","this","removeClass","parent","addClass","attr","preventDefault","val","trigger","loadWidgetData","prepareWidgets","insertAfter","closest","draggable","helper","e","target","parents","clone","distance","connectToSortable","width","css","each","replace","sortable","update","event","ui","createDatePicker","item","appendToggle","connectWith","panel","bootbox","confirm","remove","evt","is","length","children","toggleClass","saveWidgets","total","i","el","template","location","area","widgets","find","widgetData","data","serializeArray","d","hasOwnProperty","name","Array","isArray","push","value","widget","socket","emit","err","app","alertError","message","alert","alert_id","type","title","timeout","btn","selector","container","classList","join","className","currentYear","Date","getFullYear","datepicker","changeMonth","changeYear","yearRange","hasClass","droppable","accept","drop","hoverClass","append","html","populateWidget","text","input","prop","get","RELATIVE_PATH","areas","widgetArea","k","widgetEl"],"mappings":"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","file":"public/src/admin/extend/widgets.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('admin/extend/widgets', ['jqueryui'], function () {\r\n\tvar Widgets = {};\r\n\r\n\tWidgets.init = function () {\r\n\t\t$('#widgets .nav-pills a').on('click', function (ev) {\r\n\t\t\tvar $this = $(this);\r\n\t\t\t$('#widgets .nav-pills li').removeClass('active');\r\n\t\t\t$this.parent().addClass('active');\r\n\r\n\t\t\t$('#widgets .tab-pane').removeClass('active');\r\n\t\t\t$('#widgets .tab-pane[data-template=\"' + $this.attr('data-template') + '\"]').addClass('active');\r\n\r\n\t\t\tev.preventDefault();\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\t$('#widget-selector').on('change', function () {\r\n\t\t\t$('.available-widgets [data-widget]').addClass('hide');\r\n\t\t\t$('.available-widgets [data-widget=\"' + $(this).val() + '\"]').removeClass('hide');\r\n\t\t});\r\n\r\n\t\t$('#widget-selector').trigger('change');\r\n\r\n\t\tloadWidgetData();\r\n\t};\r\n\r\n\tfunction prepareWidgets() {\r\n\t\t$('[data-location=\"drafts\"]').insertAfter($('[data-location=\"drafts\"]').closest('.tab-content'));\r\n\r\n\t\t$('#widgets .available-widgets .widget-panel').draggable({\r\n\t\t\thelper: function (e) {\r\n\t\t\t\treturn $(e.target).parents('.widget-panel').clone();\r\n\t\t\t},\r\n\t\t\tdistance: 10,\r\n\t\t\tconnectToSortable: '.widget-area',\r\n\t\t});\r\n\r\n\t\t$('#widgets .available-containers .containers > [data-container-html]')\r\n\t\t\t.draggable({\r\n\t\t\t\thelper: function (e) {\r\n\t\t\t\t\tvar target = $(e.target);\r\n\t\t\t\t\ttarget = target.attr('data-container-html') ? target : target.parents('[data-container-html]');\r\n\r\n\t\t\t\t\treturn target.clone().addClass('block').width(target.width()).css('opacity', '0.5');\r\n\t\t\t\t},\r\n\t\t\t\tdistance: 10,\r\n\t\t\t})\r\n\t\t\t.each(function () {\r\n\t\t\t\t$(this).attr('data-container-html', $(this).attr('data-container-html').replace(/\\\\\\{([\\s\\S]*?)\\\\\\}/g, '{$1}'));\r\n\t\t\t});\r\n\r\n\t\t$('#widgets .widget-area').sortable({\r\n\t\t\tupdate: function (event, ui) {\r\n\t\t\t\tcreateDatePicker(ui.item);\r\n\t\t\t\tappendToggle(ui.item);\r\n\t\t\t},\r\n\t\t\tconnectWith: 'div',\r\n\t\t}).on('click', '.delete-widget', function () {\r\n\t\t\tvar panel = $(this).parents('.widget-panel');\r\n\r\n\t\t\tbootbox.confirm('[[admin/extend/widgets:alert.confirm-delete]]', function (confirm) {\r\n\t\t\t\tif (confirm) {\r\n\t\t\t\t\tpanel.remove();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}).on('mouseup', '> .panel > .panel-heading', function (evt) {\r\n\t\t\tif (!($(this).parent().is('.ui-sortable-helper') || $(evt.target).closest('.delete-widget').length)) {\r\n\t\t\t\t$(this).parent().children('.panel-body').toggleClass('hidden');\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$('#save').on('click', saveWidgets);\r\n\r\n\t\tfunction saveWidgets() {\r\n\t\t\tvar total = $('#widgets [data-template][data-location]').length;\r\n\r\n\t\t\t$('#widgets [data-template][data-location]').each(function (i, el) {\r\n\t\t\t\tel = $(el);\r\n\r\n\t\t\t\tvar template = el.attr('data-template');\r\n\t\t\t\tvar location = el.attr('data-location');\r\n\t\t\t\tvar area = el.children('.widget-area');\r\n\t\t\t\tvar widgets = [];\r\n\r\n\t\t\t\tarea.find('.widget-panel[data-widget]').each(function () {\r\n\t\t\t\t\tvar widgetData = {};\r\n\t\t\t\t\tvar data = $(this).find('form').serializeArray();\r\n\r\n\t\t\t\t\tfor (var d in data) {\r\n\t\t\t\t\t\tif (data.hasOwnProperty(d)) {\r\n\t\t\t\t\t\t\tif (data[d].name) {\r\n\t\t\t\t\t\t\t\tif (widgetData[data[d].name]) {\r\n\t\t\t\t\t\t\t\t\tif (!Array.isArray(widgetData[data[d].name])) {\r\n\t\t\t\t\t\t\t\t\t\twidgetData[data[d].name] = [\r\n\t\t\t\t\t\t\t\t\t\t\twidgetData[data[d].name],\r\n\t\t\t\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\twidgetData[data[d].name].push(data[d].value);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\twidgetData[data[d].name] = data[d].value;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\twidgets.push({\r\n\t\t\t\t\t\twidget: $(this).attr('data-widget'),\r\n\t\t\t\t\t\tdata: widgetData,\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\r\n\t\t\t\tsocket.emit('admin.widgets.set', {\r\n\t\t\t\t\ttemplate: template,\r\n\t\t\t\t\tlocation: location,\r\n\t\t\t\t\twidgets: widgets,\r\n\t\t\t\t}, function (err) {\r\n\t\t\t\t\ttotal -= 1;\r\n\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\tapp.alertError(err.message);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (total === 0) {\r\n\t\t\t\t\t\tapp.alert({\r\n\t\t\t\t\t\t\talert_id: 'admin:widgets',\r\n\t\t\t\t\t\t\ttype: 'success',\r\n\t\t\t\t\t\t\ttitle: '[[admin/extend/widgets:alert.updated]]',\r\n\t\t\t\t\t\t\tmessage: '[[admin/extend/widgets:alert.update-success]]',\r\n\t\t\t\t\t\t\ttimeout: 2500,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t$('.color-selector').on('click', '.btn', function () {\r\n\t\t\tvar btn = $(this);\r\n\t\t\tvar selector = btn.parents('.color-selector');\r\n\t\t\tvar container = selector.parents('[data-container-html]');\r\n\t\t\tvar classList = [];\r\n\r\n\t\t\tselector.children().each(function () {\r\n\t\t\t\tclassList.push($(this).attr('data-class'));\r\n\t\t\t});\r\n\r\n\t\t\tcontainer\r\n\t\t\t\t.removeClass(classList.join(' '))\r\n\t\t\t\t.addClass(btn.attr('data-class'));\r\n\r\n\t\t\tcontainer.attr('data-container-html', container.attr('data-container-html')\r\n\t\t\t\t.replace(/class=\"[a-zA-Z0-9-\\s]+\"/, 'class=\"' + container[0].className.replace(' pointer ui-draggable', '') + '\"')\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction createDatePicker(el) {\r\n\t\tvar currentYear = new Date().getFullYear();\r\n\t\tel.find('.date-selector').datepicker({\r\n\t\t\tchangeMonth: true,\r\n\t\t\tchangeYear: true,\r\n\t\t\tyearRange: currentYear + ':' + (currentYear + 100),\r\n\t\t});\r\n\t}\r\n\r\n\tfunction appendToggle(el) {\r\n\t\tif (!el.hasClass('block')) {\r\n\t\t\tel.addClass('block').css('width', '').css('height', '')\r\n\t\t\t\t.droppable({\r\n\t\t\t\t\taccept: '[data-container-html]',\r\n\t\t\t\t\tdrop: function (event, ui) {\r\n\t\t\t\t\t\tvar el = $(this);\r\n\r\n\t\t\t\t\t\tel.find('.panel-body .container-html').val(ui.draggable.attr('data-container-html'));\r\n\t\t\t\t\t\tel.find('.panel-body').removeClass('hidden');\r\n\t\t\t\t\t},\r\n\t\t\t\t\thoverClass: 'panel-info',\r\n\t\t\t\t})\r\n\t\t\t\t.children('.panel-heading')\r\n\t\t\t\t.append('<div class=\"pull-right pointer\"><span class=\"delete-widget\"><i class=\"fa fa-times-circle\"></i></span></div><div class=\"pull-left pointer\"><span class=\"toggle-widget\"><i class=\"fa fa-chevron-circle-down\"></i></span>&nbsp;</div>')\r\n\t\t\t\t.children('small').html('');\r\n\t\t}\r\n\t}\r\n\r\n\tfunction loadWidgetData() {\r\n\t\tfunction populateWidget(widget, data) {\r\n\t\t\tif (data.title) {\r\n\t\t\t\tvar title = widget.find('.panel-heading strong');\r\n\t\t\t\ttitle.text(title.text() + ' - ' + data.title);\r\n\t\t\t}\r\n\r\n\t\t\twidget.find('input, textarea, select').each(function () {\r\n\t\t\t\tvar input = $(this);\r\n\t\t\t\tvar value = data[input.attr('name')];\r\n\r\n\t\t\t\tif (input.attr('type') === 'checkbox') {\r\n\t\t\t\t\tinput.prop('checked', !!value).trigger('change');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tinput.val(value);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\treturn widget;\r\n\t\t}\r\n\r\n\t\t$.get(RELATIVE_PATH + '/api/admin/extend/widgets', function (data) {\r\n\t\t\tvar areas = data.areas;\r\n\r\n\t\t\tfor (var i = 0; i < areas.length; i += 1) {\r\n\t\t\t\tvar area = areas[i];\r\n\t\t\t\tvar widgetArea = $('#widgets .area[data-template=\"' + area.template + '\"][data-location=\"' + area.location + '\"]').find('.widget-area');\r\n\r\n\t\t\t\twidgetArea.html('');\r\n\r\n\t\t\t\tfor (var k = 0; k < area.data.length; k += 1) {\r\n\t\t\t\t\tvar widgetData = area.data[k];\r\n\t\t\t\t\tvar widgetEl = $('.available-widgets [data-widget=\"' + widgetData.widget + '\"]').clone(true).removeClass('hide');\r\n\r\n\t\t\t\t\twidgetArea.append(populateWidget(widgetEl, widgetData.data));\r\n\t\t\t\t\tappendToggle(widgetEl);\r\n\t\t\t\t\tcreateDatePicker(widgetEl);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tprepareWidgets();\r\n\t\t});\r\n\t}\r\n\r\n\treturn Widgets;\r\n});\r\n"]}