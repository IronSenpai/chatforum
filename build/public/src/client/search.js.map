{"version":3,"sources":["public/src/client/search.js"],"names":["define","searchModule","autocomplete","storage","Search","init","searchQuery","$","attr","searchIn","on","updateFormItemVisiblity","val","highlightMatches","off","e","preventDefault","query","getSearchDataFromDOM","handleSavePreferences","enableAutoComplete","fillOutForm","form","searchData","in","term","by","find","categories","searchChildren","is","hasTags","tagsinput","replies","repliesFilter","timeFilter","timeRange","sortBy","sortDirection","showAs","window","trigger","data","hide","indexOf","toggleClass","params","utils","getSearchPreferences","formData","merge","ajaxify","prop","Array","isArray","forEach","tag","searchDefaultSortBy","isTopic","isPost","parent","regexStr","replace","trim","split","join","regex","RegExp","each","result","this","nested","after","length","push","append","html","i","ii","addClass","setItem","JSON","stringify","app","alertSuccess","removeItem","reset","user","tagEl","confirmKeys","trimValue","siblings"],"mappings":"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","file":"public/src/client/search.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/search', ['search', 'autocomplete', 'storage'], function (searchModule, autocomplete, storage) {\r\n\tvar\tSearch = {};\r\n\r\n\tSearch.init = function () {\r\n\t\tvar searchQuery = $('#results').attr('data-search-query');\r\n\r\n\t\tvar searchIn = $('#search-in');\r\n\r\n\t\tsearchIn.on('change', function () {\r\n\t\t\tupdateFormItemVisiblity(searchIn.val());\r\n\t\t});\r\n\r\n\t\thighlightMatches(searchQuery);\r\n\r\n\t\t$('#advanced-search').off('submit').on('submit', function (e) {\r\n\t\t\te.preventDefault();\r\n\t\t\tsearchModule.query(getSearchDataFromDOM(), function () {\r\n\t\t\t\t$('#search-input').val('');\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\thandleSavePreferences();\r\n\r\n\t\tenableAutoComplete();\r\n\r\n\t\tfillOutForm();\r\n\t};\r\n\r\n\tfunction getSearchDataFromDOM() {\r\n\t\tvar form = $('#advanced-search');\r\n\t\tvar searchData = {\r\n\t\t\tin: $('#search-in').val(),\r\n\t\t};\r\n\t\tsearchData.term = $('#search-input').val();\r\n\t\tif (searchData.in === 'posts' || searchData.in === 'titlesposts' || searchData.in === 'titles') {\r\n\t\t\tsearchData.by = form.find('#posted-by-user').val();\r\n\t\t\tsearchData.categories = form.find('#posted-in-categories').val();\r\n\t\t\tsearchData.searchChildren = form.find('#search-children').is(':checked');\r\n\t\t\tsearchData.hasTags = form.find('#has-tags').tagsinput('items');\r\n\t\t\tsearchData.replies = form.find('#reply-count').val();\r\n\t\t\tsearchData.repliesFilter = form.find('#reply-count-filter').val();\r\n\t\t\tsearchData.timeFilter = form.find('#post-time-filter').val();\r\n\t\t\tsearchData.timeRange = form.find('#post-time-range').val();\r\n\t\t\tsearchData.sortBy = form.find('#post-sort-by').val();\r\n\t\t\tsearchData.sortDirection = form.find('#post-sort-direction').val();\r\n\t\t\tsearchData.showAs = form.find('#show-as-topics').is(':checked') ? 'topics' : 'posts';\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:search.getSearchDataFromDOM', {\r\n\t\t\tform: form,\r\n\t\t\tdata: searchData,\r\n\t\t});\r\n\r\n\t\treturn searchData;\r\n\t}\r\n\r\n\tfunction updateFormItemVisiblity(searchIn) {\r\n\t\tvar hide = searchIn.indexOf('posts') === -1 && searchIn.indexOf('titles') === -1;\r\n\t\t$('.post-search-item').toggleClass('hide', hide);\r\n\t}\r\n\r\n\tfunction fillOutForm() {\r\n\t\tvar params = utils.params();\r\n\r\n\t\tvar searchData = searchModule.getSearchPreferences();\r\n\t\tvar formData = utils.merge(searchData, params);\r\n\r\n\t\tif (formData) {\r\n\t\t\tif (ajaxify.data.term) {\r\n\t\t\t\t$('#search-input').val(ajaxify.data.term);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.in) {\r\n\t\t\t\t$('#search-in').val(formData.in);\r\n\t\t\t\tupdateFormItemVisiblity(formData.in);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.by) {\r\n\t\t\t\t$('#posted-by-user').val(formData.by);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.categories) {\r\n\t\t\t\t$('#posted-in-categories').val(formData.categories);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.searchChildren) {\r\n\t\t\t\t$('#search-children').prop('checked', true);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.hasTags) {\r\n\t\t\t\tformData.hasTags = Array.isArray(formData.hasTags) ? formData.hasTags : [formData.hasTags];\r\n\t\t\t\tformData.hasTags.forEach(function (tag) {\r\n\t\t\t\t\t$('#has-tags').tagsinput('add', tag);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.replies) {\r\n\t\t\t\t$('#reply-count').val(formData.replies);\r\n\t\t\t\t$('#reply-count-filter').val(formData.repliesFilter);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.timeRange) {\r\n\t\t\t\t$('#post-time-range').val(formData.timeRange);\r\n\t\t\t\t$('#post-time-filter').val(formData.timeFilter);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.sortBy || ajaxify.data.searchDefaultSortBy) {\r\n\t\t\t\t$('#post-sort-by').val(formData.sortBy || ajaxify.data.searchDefaultSortBy);\r\n\t\t\t\t$('#post-sort-direction').val(formData.sortDirection);\r\n\t\t\t}\r\n\r\n\t\t\tif (formData.showAs) {\r\n\t\t\t\tvar isTopic = formData.showAs === 'topics';\r\n\t\t\t\tvar isPost = formData.showAs === 'posts';\r\n\t\t\t\t$('#show-as-topics').prop('checked', isTopic).parent().toggleClass('active', isTopic);\r\n\t\t\t\t$('#show-as-posts').prop('checked', isPost).parent().toggleClass('active', isPost);\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:search.fillOutForm', {\r\n\t\t\t\tform: formData,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tfunction highlightMatches(searchQuery) {\r\n\t\tif (!searchQuery) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar regexStr = searchQuery.replace(/^\"/, '').replace(/\"$/, '').trim().split(' ').join('|');\r\n\t\tvar regex = new RegExp('(' + regexStr + ')', 'gi');\r\n\r\n\t\t$('.search-result-text p, .search-result-text h4').each(function () {\r\n\t\t\tvar result = $(this);\r\n\t\t\tvar nested = [];\r\n\r\n\t\t\tresult.find('*').each(function () {\r\n\t\t\t\t$(this).after('<!-- ' + nested.length + ' -->');\r\n\t\t\t\tnested.push($('<div />').append($(this)));\r\n\t\t\t});\r\n\r\n\t\t\tresult.html(result.html().replace(regex, '<strong>$1</strong>'));\r\n\r\n\t\t\tfor (var i = 0, ii = nested.length; i < ii; i += 1) {\r\n\t\t\t\tresult.html(result.html().replace('<!-- ' + i + ' -->', nested[i].html()));\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$('.search-result-text').find('img:not(.not-responsive)').addClass('img-responsive');\r\n\t}\r\n\r\n\tfunction handleSavePreferences() {\r\n\t\t$('#save-preferences').on('click', function () {\r\n\t\t\tstorage.setItem('search-preferences', JSON.stringify(getSearchDataFromDOM()));\r\n\t\t\tapp.alertSuccess('[[search:search-preferences-saved]]');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\t$('#clear-preferences').on('click', function () {\r\n\t\t\tstorage.removeItem('search-preferences');\r\n\t\t\tvar query = $('#search-input').val();\r\n\t\t\t$('#advanced-search')[0].reset();\r\n\t\t\t$('#search-input').val(query);\r\n\t\t\tapp.alertSuccess('[[search:search-preferences-cleared]]');\r\n\t\t\treturn false;\r\n\t\t});\r\n\t}\r\n\r\n\tfunction enableAutoComplete() {\r\n\t\tautocomplete.user($('#posted-by-user'));\r\n\r\n\t\tvar tagEl = $('#has-tags');\r\n\t\ttagEl.tagsinput({\r\n\t\t\tconfirmKeys: [13, 44],\r\n\t\t\ttrimValue: true,\r\n\t\t});\r\n\r\n\t\tautocomplete.tag($('#has-tags').siblings('.bootstrap-tagsinput').find('input'));\r\n\t}\r\n\r\n\treturn Search;\r\n});\r\n"]}