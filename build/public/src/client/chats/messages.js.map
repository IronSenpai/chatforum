{"version":3,"sources":["public/src/client/chats/messages.js"],"names":["define","components","sounds","translator","messages","sendMessage","roomId","inputEl","msg","val","mid","attr","length","ajaxify","data","maximumChatMessageLength","app","alertError","removeAttr","$","window","trigger","message","socket","emit","err","showEmailConfirmWarning","alert","alert_id","title","type","timeout","play","appendChatMessage","chatContentEl","lastSpeaker","parseInt","find","last","lasttimestamp","Array","isArray","newSet","fromuid","timestamp","parseMessage","html","onMessagesParsed","newMessage","appendTo","timeago","addClass","scrollToBottom","callback","templates","parse","translate","containerEl","scrollTop","scrollHeight","height","prepEdit","messageId","raw","onChatMessageEdit","on","forEach","self","user","uid","body","get","replaceWith","delete","translated","bootbox","confirm","ok","slideUp","this","remove"],"mappings":"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","file":"public/src/client/chats/messages.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/chats/messages', ['components', 'sounds', 'translator'], function (components, sounds, translator) {\r\n\tvar messages = {};\r\n\r\n\tmessages.sendMessage = function (roomId, inputEl) {\r\n\t\tvar msg = inputEl.val();\r\n\t\tvar mid = inputEl.attr('data-mid');\r\n\r\n\t\tif (msg.length > ajaxify.data.maximumChatMessageLength) {\r\n\t\t\treturn app.alertError('[[error:chat-message-too-long,' + ajaxify.data.maximumChatMessageLength + ']]');\r\n\t\t}\r\n\r\n\t\tif (!msg.length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tinputEl.val('');\r\n\t\tinputEl.removeAttr('data-mid');\r\n\r\n\t\t$(window).trigger('action:chat.sent', {\r\n\t\t\troomId: roomId,\r\n\t\t\tmessage: msg,\r\n\t\t\tmid: mid,\r\n\t\t});\r\n\r\n\t\tif (!mid) {\r\n\t\t\tsocket.emit('modules.chats.send', {\r\n\t\t\t\troomId: roomId,\r\n\t\t\t\tmessage: msg,\r\n\t\t\t}, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tinputEl.val(msg);\r\n\t\t\t\t\tif (err.message === '[[error:email-not-confirmed-chat]]') {\r\n\t\t\t\t\t\treturn app.showEmailConfirmWarning(err);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn app.alert({\r\n\t\t\t\t\t\talert_id: 'chat_spam_error',\r\n\t\t\t\t\t\ttitle: '[[global:alert.error]]',\r\n\t\t\t\t\t\tmessage: err.message,\r\n\t\t\t\t\t\ttype: 'danger',\r\n\t\t\t\t\t\ttimeout: 10000,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tsounds.play('chat-outgoing');\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tsocket.emit('modules.chats.edit', {\r\n\t\t\t\troomId: roomId,\r\n\t\t\t\tmid: mid,\r\n\t\t\t\tmessage: msg,\r\n\t\t\t}, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tinputEl.val(msg);\r\n\t\t\t\t\tinputEl.attr('data-mid', mid);\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tmessages.appendChatMessage = function (chatContentEl, data) {\r\n\t\tvar lastSpeaker = parseInt(chatContentEl.find('.chat-message').last().attr('data-uid'), 10);\r\n\t\tvar lasttimestamp = parseInt(chatContentEl.find('.chat-message').last().attr('data-timestamp'), 10);\r\n\t\tif (!Array.isArray(data)) {\r\n\t\t\tdata.newSet = lastSpeaker !== parseInt(data.fromuid, 10) ||\r\n\t\t\t\tparseInt(data.timestamp, 10) > parseInt(lasttimestamp, 10) + (1000 * 60 * 3);\r\n\t\t}\r\n\r\n\t\tmessages.parseMessage(data, function (html) {\r\n\t\t\tonMessagesParsed(chatContentEl, html);\r\n\t\t});\r\n\t};\r\n\r\n\tfunction onMessagesParsed(chatContentEl, html) {\r\n\t\tvar newMessage = $(html);\r\n\r\n\t\tnewMessage.appendTo(chatContentEl);\r\n\t\tnewMessage.find('.timeago').timeago();\r\n\t\tnewMessage.find('img:not(.not-responsive)').addClass('img-responsive');\r\n\t\tmessages.scrollToBottom(chatContentEl);\r\n\t}\r\n\r\n\r\n\tmessages.parseMessage = function (data, callback) {\r\n\t\ttemplates.parse('partials/chats/message' + (Array.isArray(data) ? 's' : ''), {\r\n\t\t\tmessages: data,\r\n\t\t}, function (html) {\r\n\t\t\ttranslator.translate(html, callback);\r\n\t\t});\r\n\t};\r\n\r\n\r\n\tmessages.scrollToBottom = function (containerEl) {\r\n\t\tif (containerEl.length) {\r\n\t\t\tcontainerEl.scrollTop(\r\n\t\t\t\tcontainerEl[0].scrollHeight - containerEl.height()\r\n\t\t\t);\r\n\t\t}\r\n\t};\r\n\r\n\tmessages.prepEdit = function (inputEl, messageId, roomId) {\r\n\t\tsocket.emit('modules.chats.getRaw', { mid: messageId, roomId: roomId }, function (err, raw) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\t\t\t// Populate the input field with the raw message content\r\n\t\t\tif (inputEl.val().length === 0) {\r\n\t\t\t\t// By setting the `data-mid` attribute, I tell the chat code that I am editing a\r\n\t\t\t\t// message, instead of posting a new one.\r\n\t\t\t\tinputEl.attr('data-mid', messageId).addClass('editing');\r\n\t\t\t\tinputEl.val(raw);\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tmessages.onChatMessageEdit = function () {\r\n\t\tsocket.on('event:chats.edit', function (data) {\r\n\t\t\tdata.messages.forEach(function (message) {\r\n\t\t\t\tvar self = parseInt(message.fromuid, 10) === parseInt(app.user.uid, 10);\r\n\t\t\t\tmessage.self = self ? 1 : 0;\r\n\t\t\t\tmessages.parseMessage(message, function (html) {\r\n\t\t\t\t\tvar body = components.get('chat/message', message.messageId);\r\n\t\t\t\t\tif (body.length) {\r\n\t\t\t\t\t\tbody.replaceWith(html);\r\n\t\t\t\t\t\tcomponents.get('chat/message', message.messageId).find('.timeago').timeago();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tmessages.delete = function (messageId, roomId) {\r\n\t\ttranslator.translate('[[modules:chat.delete_message_confirm]]', function (translated) {\r\n\t\t\tbootbox.confirm(translated, function (ok) {\r\n\t\t\t\tif (!ok) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tsocket.emit('modules.chats.delete', {\r\n\t\t\t\t\tmessageId: messageId,\r\n\t\t\t\t\troomId: roomId,\r\n\t\t\t\t}, function (err) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tcomponents.get('chat/message', messageId).slideUp('slow', function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\treturn messages;\r\n});\r\n"]}