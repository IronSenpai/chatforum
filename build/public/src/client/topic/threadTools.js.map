{"version":3,"sources":["public/src/client/topic/threadTools.js"],"names":["define","fork","move","deletePosts","components","translator","ThreadTools","init","tid","renderMenu","topicContainer","$","on","topicCommand","socket","emit","tids","cid","ajaxify","data","err","app","alertError","alertSuccess","btn","this","message","parents","find","trigger","changeWatching","type","alert","alert_id","title","timeout","setFollowState","window","$this","dropdownMenu","html","templates","parse","translate","command","msg","bootbox","confirm","setLockedState","threadEl","get","parseInt","attr","isLocked","privileges","isAdminOrMod","toggleClass","hideReply","deleted","user","uid","locked","setDeleteState","isDelete","setPinnedState","isPinned","pinned","state","menu"],"mappings":"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","file":"public/src/client/topic/threadTools.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic/threadTools', [\r\n\t'forum/topic/fork',\r\n\t'forum/topic/move',\r\n\t'forum/topic/delete-posts',\r\n\t'components',\r\n\t'translator',\r\n], function (fork, move, deletePosts, components, translator) {\r\n\tvar ThreadTools = {};\r\n\r\n\tThreadTools.init = function (tid) {\r\n\t\trenderMenu();\r\n\r\n\t\tvar topicContainer = $('.topic');\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/delete\"]', function () {\r\n\t\t\ttopicCommand('delete', tid);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/restore\"]', function () {\r\n\t\t\ttopicCommand('restore', tid);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/purge\"]', function () {\r\n\t\t\ttopicCommand('purge', tid);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/lock\"]', function () {\r\n\t\t\tsocket.emit('topics.lock', { tids: [tid], cid: ajaxify.data.cid });\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/unlock\"]', function () {\r\n\t\t\tsocket.emit('topics.unlock', { tids: [tid], cid: ajaxify.data.cid });\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/pin\"]', function () {\r\n\t\t\tsocket.emit('topics.pin', { tids: [tid], cid: ajaxify.data.cid });\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/unpin\"]', function () {\r\n\t\t\tsocket.emit('topics.unpin', { tids: [tid], cid: ajaxify.data.cid });\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/mark-unread\"]', function () {\r\n\t\t\tsocket.emit('topics.markUnread', tid, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err);\r\n\t\t\t\t}\r\n\t\t\t\tapp.alertSuccess('[[topic:mark_unread.success]]');\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/mark-unread-for-all\"]', function () {\r\n\t\t\tvar btn = $(this);\r\n\t\t\tsocket.emit('topics.markAsUnreadForAll', [tid], function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tapp.alertSuccess('[[topic:markAsUnreadForAll.success]]');\r\n\t\t\t\tbtn.parents('.thread-tools.open').find('.dropdown-toggle').trigger('click');\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/move\"]', function () {\r\n\t\t\tmove.init([tid], ajaxify.data.cid);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tdeletePosts.init();\r\n\t\tfork.init();\r\n\r\n\t\t$('.topic').on('click', '[component=\"topic/following\"]', function () {\r\n\t\t\tchangeWatching('follow');\r\n\t\t});\r\n\t\t$('.topic').on('click', '[component=\"topic/not-following\"]', function () {\r\n\t\t\tchangeWatching('unfollow');\r\n\t\t});\r\n\t\t$('.topic').on('click', '[component=\"topic/ignoring\"]', function () {\r\n\t\t\tchangeWatching('ignore');\r\n\t\t});\r\n\r\n\t\tfunction changeWatching(type) {\r\n\t\t\tsocket.emit('topics.changeWatching', { tid: tid, type: type }, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alert({\r\n\t\t\t\t\t\ttype: 'danger',\r\n\t\t\t\t\t\talert_id: 'topic_follow',\r\n\t\t\t\t\t\ttitle: '[[global:please_log_in]]',\r\n\t\t\t\t\t\tmessage: '[[topic:login_to_subscribe]]',\r\n\t\t\t\t\t\ttimeout: 5000,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tvar message = '';\r\n\t\t\t\tif (type === 'follow') {\r\n\t\t\t\t\tmessage = '[[topic:following_topic.message]]';\r\n\t\t\t\t} else if (type === 'unfollow') {\r\n\t\t\t\t\tmessage = '[[topic:not_following_topic.message]]';\r\n\t\t\t\t} else if (type === 'ignore') {\r\n\t\t\t\t\tmessage = '[[topic:ignoring_topic.message]]';\r\n\t\t\t\t}\r\n\t\t\t\tsetFollowState(type);\r\n\r\n\t\t\t\tapp.alert({\r\n\t\t\t\t\talert_id: 'follow_thread',\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\ttype: 'success',\r\n\t\t\t\t\ttimeout: 5000,\r\n\t\t\t\t});\r\n\r\n\t\t\t\t$(window).trigger('action:topics.changeWatching', { tid: tid, type: type });\r\n\t\t\t});\r\n\r\n\t\t\treturn false;\r\n\t\t}\r\n\t};\r\n\r\n\tfunction renderMenu() {\r\n\t\t$('.topic').on('show.bs.dropdown', '.thread-tools', function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar dropdownMenu = $this.find('.dropdown-menu');\r\n\t\t\tif (dropdownMenu.html()) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tsocket.emit('topics.loadTopicTools', { tid: ajaxify.data.tid, cid: ajaxify.data.cid }, function (err, data) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err);\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttemplates.parse('partials/topic/topic-menu-list', data, function (html) {\r\n\t\t\t\t\ttranslator.translate(html, function (html) {\r\n\t\t\t\t\t\tdropdownMenu.html(html);\r\n\t\t\t\t\t\t$(window).trigger('action:topic.tools.load');\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction topicCommand(command, tid) {\r\n\t\ttranslator.translate('[[topic:thread_tools.' + command + '_confirm]]', function (msg) {\r\n\t\t\tbootbox.confirm(msg, function (confirm) {\r\n\t\t\t\tif (!confirm) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tsocket.emit('topics.' + command, { tids: [tid], cid: ajaxify.data.cid }, function (err) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\tapp.alertError(err.message);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tThreadTools.setLockedState = function (data) {\r\n\t\tvar threadEl = components.get('topic');\r\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar isLocked = data.isLocked && !ajaxify.data.privileges.isAdminOrMod;\r\n\r\n\t\tcomponents.get('topic/lock').toggleClass('hidden', data.isLocked);\r\n\t\tcomponents.get('topic/unlock').toggleClass('hidden', !data.isLocked);\r\n\r\n\t\tvar hideReply = (data.isLocked || ajaxify.data.deleted) && !ajaxify.data.privileges.isAdminOrMod;\r\n\r\n\t\tcomponents.get('topic/reply/container').toggleClass('hidden', hideReply);\r\n\t\tcomponents.get('topic/reply/locked').toggleClass('hidden', ajaxify.data.privileges.isAdminOrMod || !data.isLocked || ajaxify.data.deleted);\r\n\r\n\t\tthreadEl.find('[component=\"post\"]:not(.deleted) [component=\"post/reply\"], [component=\"post\"]:not(.deleted) [component=\"post/quote\"]').toggleClass('hidden', hideReply);\r\n\t\tthreadEl.find('[component=\"post/edit\"], [component=\"post/delete\"]').toggleClass('hidden', isLocked);\r\n\r\n\t\tthreadEl.find('[component=\"post\"][data-uid=\"' + app.user.uid + '\"].deleted [component=\"post/tools\"]').toggleClass('hidden', isLocked);\r\n\r\n\t\t$('[component=\"post/header\"] i.fa-lock').toggleClass('hidden', !data.isLocked);\r\n\t\t$('[component=\"post/tools\"] .dropdown-menu').html('');\r\n\t\tajaxify.data.locked = data.isLocked;\r\n\t};\r\n\r\n\tThreadTools.setDeleteState = function (data) {\r\n\t\tvar threadEl = components.get('topic');\r\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcomponents.get('topic/delete').toggleClass('hidden', data.isDelete);\r\n\t\tcomponents.get('topic/restore').toggleClass('hidden', !data.isDelete);\r\n\t\tcomponents.get('topic/purge').toggleClass('hidden', !data.isDelete);\r\n\t\tcomponents.get('topic/deleted/message').toggleClass('hidden', !data.isDelete);\r\n\r\n\t\tvar hideReply = data.isDelete && !ajaxify.data.privileges.isAdminOrMod;\r\n\r\n\t\tcomponents.get('topic/reply/container').toggleClass('hidden', hideReply);\r\n\t\tcomponents.get('topic/reply/locked').toggleClass('hidden', ajaxify.data.privileges.isAdminOrMod || !ajaxify.data.locked || data.isDelete);\r\n\t\tthreadEl.find('[component=\"post\"]:not(.deleted) [component=\"post/reply\"], [component=\"post\"]:not(.deleted) [component=\"post/quote\"]').toggleClass('hidden', hideReply);\r\n\r\n\t\tthreadEl.toggleClass('deleted', data.isDelete);\r\n\t\tajaxify.data.deleted = data.isDelete;\r\n\t};\r\n\r\n\r\n\tThreadTools.setPinnedState = function (data) {\r\n\t\tvar threadEl = components.get('topic');\r\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcomponents.get('topic/pin').toggleClass('hidden', data.isPinned);\r\n\t\tcomponents.get('topic/unpin').toggleClass('hidden', !data.isPinned);\r\n\t\t$('[component=\"post/header\"] i.fa-thumb-tack').toggleClass('hidden', !data.isPinned);\r\n\t\tajaxify.data.pinned = data.isPinned;\r\n\t};\r\n\r\n\tfunction setFollowState(state) {\r\n\t\tvar menu = components.get('topic/following/menu');\r\n\t\tmenu.toggleClass('hidden', state !== 'follow');\r\n\t\tcomponents.get('topic/following/check').toggleClass('fa-check', state === 'follow');\r\n\r\n\t\tmenu = components.get('topic/not-following/menu');\r\n\t\tmenu.toggleClass('hidden', state !== 'unfollow');\r\n\t\tcomponents.get('topic/not-following/check').toggleClass('fa-check', state === 'unfollow');\r\n\r\n\t\tmenu = components.get('topic/ignoring/menu');\r\n\t\tmenu.toggleClass('hidden', state !== 'ignore');\r\n\t\tcomponents.get('topic/ignoring/check').toggleClass('fa-check', state === 'ignore');\r\n\t}\r\n\r\n\r\n\treturn ThreadTools;\r\n});\r\n"]}