{"version":3,"sources":["public/src/client/topic/posts.js"],"names":["define","pagination","infinitescroll","postTools","images","navigator","components","Posts","onNewPost","data","posts","length","parseInt","tid","ajaxify","loggedIn","app","user","uid","privileges","timestamp","Date","now","timestampISO","utils","toISOString","modifyPostsByPrivileges","updatePostCounts","postcount","updatePostCount","config","usePagination","onNewPostPagination","onNewPostInfiniteScroll","require","replies","forEach","post","selfPost","display_edit_tools","isAdminOrMod","display_delete_tools","display_moderator_tools","display_move_tools","display_post_menu","locked","postSharing","deleted","i","cmp","get","html","attr","addCommasToNumbers","scrollToPost","scrollToPostIfSelf","loadImages","pageCount","Math","max","ceil","topic","postsPerPage","direction","topicPostSort","isPostVisible","currentPage","createNewPosts","not","scrollToMyPost","setTimeout","loadPage","updatePagination","$","relative_path","page","paginationData","parseAndTranslate","after","remove","isPreviousPostAdded","index","addClass","scrollBottom","repliesSelector","callback","removeAlreadyAddedPosts","newPosts","allSamePids","each","el","pid","this","removeClass","p","hasClass","filter","before","last","first","slug","window","trigger","insertAfter","height","document","scrollTop","insertBefore","append","removeExtra","processPage","loadMorePosts","scrollActive","_infiniteScrollTimeout","afterEl","isNumber","indicatorEl","is","fadeIn","loadMore","count","done","fadeOut","update","unloadImages","showBottomPostBar","find","createUserTooltips","replaceSelfLinks","makeNumbersHumanReadable","timeago","addBlockquoteEllipses","hidePostToolsForDeletedPosts","mainPost","placeHolder","clone","toggle","blockquotes","$this"],"mappings":"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","file":"public/src/client/topic/posts.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic/posts', [\r\n\t'forum/pagination',\r\n\t'forum/infinitescroll',\r\n\t'forum/topic/postTools',\r\n\t'forum/topic/images',\r\n\t'navigator',\r\n\t'components',\r\n], function (pagination, infinitescroll, postTools, images, navigator, components) {\r\n\tvar Posts = { };\r\n\r\n\tPosts.onNewPost = function (data) {\r\n\t\tif (!data || !data.posts || !data.posts.length || parseInt(data.posts[0].tid, 10) !== parseInt(ajaxify.data.tid, 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tdata.loggedIn = !!app.user.uid;\r\n\t\tdata.privileges = ajaxify.data.privileges;\r\n\r\n\t\t// prevent timeago in future by setting timestamp to 1 sec behind now\r\n\t\tdata.posts[0].timestamp = Date.now() - 1000;\r\n\t\tdata.posts[0].timestampISO = utils.toISOString(data.posts[0].timestamp);\r\n\r\n\t\tPosts.modifyPostsByPrivileges(data.posts);\r\n\r\n\t\tupdatePostCounts(data.posts);\r\n\r\n\t\tajaxify.data.postcount += 1;\r\n\t\tpostTools.updatePostCount(ajaxify.data.postcount);\r\n\r\n\t\tif (config.usePagination) {\r\n\t\t\tonNewPostPagination(data);\r\n\t\t} else {\r\n\t\t\tonNewPostInfiniteScroll(data);\r\n\t\t}\r\n\r\n\t\trequire(['forum/topic/replies'], function (replies) {\r\n\t\t\treplies.onNewPost(data);\r\n\t\t});\r\n\t};\r\n\r\n\tPosts.modifyPostsByPrivileges = function (posts) {\r\n\t\tposts.forEach(function (post) {\r\n\t\t\tpost.selfPost = !!app.user.uid && parseInt(post.uid, 10) === parseInt(app.user.uid, 10);\r\n\t\t\tpost.display_edit_tools = (ajaxify.data.privileges['posts:edit'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_delete_tools = (ajaxify.data.privileges['posts:delete'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_moderator_tools = post.display_edit_tools || post.display_delete_tools;\r\n\t\t\tpost.display_move_tools = ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_post_menu = ajaxify.data.privileges.isAdminOrMod || (post.selfPost && !ajaxify.data.locked) || ((app.user.uid || ajaxify.data.postSharing.length) && !post.deleted);\r\n\t\t});\r\n\t};\r\n\r\n\tfunction updatePostCounts(posts) {\r\n\t\tfor (var i = 0; i < posts.length; i += 1) {\r\n\t\t\tvar cmp = components.get('user/postcount', posts[i].uid);\r\n\t\t\tcmp.html(parseInt(cmp.attr('data-postcount'), 10) + 1);\r\n\t\t\tutils.addCommasToNumbers(cmp);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction onNewPostPagination(data) {\r\n\t\tfunction scrollToPost() {\r\n\t\t\tscrollToPostIfSelf(data.posts[0]);\r\n\t\t\timages.loadImages();\r\n\t\t}\r\n\r\n\t\tvar posts = data.posts;\r\n\r\n\t\tajaxify.data.pagination.pageCount = Math.max(1, Math.ceil((posts[0].topic.postcount - 1) / config.postsPerPage));\r\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\r\n\r\n\t\tvar isPostVisible = (ajaxify.data.pagination.currentPage === ajaxify.data.pagination.pageCount && direction === 1) ||\r\n\t\t\t\t\t\t\t(ajaxify.data.pagination.currentPage === 1 && direction === -1);\r\n\r\n\t\tif (isPostVisible) {\r\n\t\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, scrollToPost);\r\n\t\t} else if (ajaxify.data.scrollToMyPost && parseInt(posts[0].uid, 10) === parseInt(app.user.uid, 10)) {\r\n\t\t\t// https://github.com/NodeBB/NodeBB/issues/5004#issuecomment-247157441\r\n\t\t\tsetTimeout(function () {\r\n\t\t\t\tpagination.loadPage(ajaxify.data.pagination.pageCount, scrollToPost);\r\n\t\t\t}, 250);\r\n\t\t} else {\r\n\t\t\tupdatePagination();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction updatePagination() {\r\n\t\t$.get(config.relative_path + '/api/topic/pagination/' + ajaxify.data.tid, { page: ajaxify.data.pagination.currentPage }, function (paginationData) {\r\n\t\t\tapp.parseAndTranslate('partials/paginator', { pagination: paginationData }, function (html) {\r\n\t\t\t\t$('[component=\"pagination\"]').after(html).remove();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onNewPostInfiniteScroll(data) {\r\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\r\n\r\n\t\tvar isPreviousPostAdded = $('[component=\"post\"][data-index=\"' + (data.posts[0].index - 1) + '\"]').length;\r\n\t\tif (!isPreviousPostAdded && (!data.posts[0].selfPost || !ajaxify.data.scrollToMyPost)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, function (html) {\r\n\t\t\tif (html) {\r\n\t\t\t\thtml.addClass('new');\r\n\t\t\t}\r\n\t\t\tscrollToPostIfSelf(data.posts[0]);\r\n\t\t\timages.loadImages();\r\n\t\t});\r\n\t}\r\n\r\n\tfunction scrollToPostIfSelf(post) {\r\n\t\tif (post.selfPost && ajaxify.data.scrollToMyPost) {\r\n\t\t\tnavigator.scrollBottom(post.index);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction createNewPosts(data, repliesSelector, direction, callback) {\r\n\t\tcallback = callback || function () {};\r\n\t\tif (!data || (data.posts && !data.posts.length)) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tfunction removeAlreadyAddedPosts() {\r\n\t\t\tvar newPosts = $('[component=\"post\"].new');\r\n\r\n\t\t\tif (newPosts.length === data.posts.length) {\r\n\t\t\t\tvar allSamePids = true;\r\n\t\t\t\tnewPosts.each(function (index, el) {\r\n\t\t\t\t\tif (parseInt($(el).attr('data-pid'), 10) !== parseInt(data.posts[index].pid, 10)) {\r\n\t\t\t\t\t\tallSamePids = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (allSamePids) {\r\n\t\t\t\t\tnewPosts.each(function () {\r\n\t\t\t\t\t\t$(this).removeClass('new');\r\n\t\t\t\t\t});\r\n\t\t\t\t\tdata.posts.length = 0;\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (newPosts.length && data.posts.length > 1) {\r\n\t\t\t\tdata.posts.forEach(function (post) {\r\n\t\t\t\t\tvar p = components.get('post', 'pid', post.pid);\r\n\t\t\t\t\tif (p.hasClass('new')) {\r\n\t\t\t\t\t\tp.remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tdata.posts = data.posts.filter(function (post) {\r\n\t\t\t\treturn $('[component=\"post\"][data-pid=\"' + post.pid + '\"]').length === 0;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tremoveAlreadyAddedPosts();\r\n\r\n\t\tif (!data.posts.length) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tvar after;\r\n\t\tvar before;\r\n\r\n\t\tif (direction > 0 && repliesSelector.length) {\r\n\t\t\tafter = repliesSelector.last();\r\n\t\t} else if (direction < 0 && repliesSelector.length) {\r\n\t\t\tbefore = repliesSelector.first();\r\n\t\t}\r\n\r\n\t\tdata.slug = ajaxify.data.slug;\r\n\r\n\t\t$(window).trigger('action:posts.loading', { posts: data.posts, after: after, before: before });\r\n\r\n\t\tapp.parseAndTranslate('topic', 'posts', data, function (html) {\r\n\t\t\thtml = html.filter(function () {\r\n\t\t\t\tvar pid = $(this).attr('data-pid');\r\n\t\t\t\treturn pid && $('[component=\"post\"][data-pid=\"' + pid + '\"]').length === 0;\r\n\t\t\t});\r\n\r\n\t\t\tif (after) {\r\n\t\t\t\thtml.insertAfter(after);\r\n\t\t\t} else if (before) {\r\n\t\t\t\t// Save document height and position for future reference (about 5 lines down)\r\n\t\t\t\tvar height = $(document).height();\r\n\t\t\t\tvar scrollTop = $(window).scrollTop();\r\n\r\n\t\t\t\thtml.insertBefore(before);\r\n\r\n\t\t\t\t// Now restore the relative position the user was on prior to new post insertion\r\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\r\n\t\t\t} else {\r\n\t\t\t\tcomponents.get('topic').append(html);\r\n\t\t\t}\r\n\r\n\t\t\tinfinitescroll.removeExtra($('[component=\"post\"]'), direction, config.postsPerPage * 2);\r\n\r\n\t\t\t$(window).trigger('action:posts.loaded', { posts: data.posts });\r\n\r\n\t\t\tPosts.processPage(html);\r\n\r\n\t\t\tcallback(html);\r\n\t\t});\r\n\t}\r\n\r\n\tPosts.loadMorePosts = function (direction) {\r\n\t\tif (!components.get('topic').length || navigator.scrollActive || Posts._infiniteScrollTimeout) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tPosts._infiniteScrollTimeout = setTimeout(function () {\r\n\t\t\tdelete Posts._infiniteScrollTimeout;\r\n\t\t}, 1000);\r\n\t\tvar replies = components.get('post').not('[data-index=0]').not('.new');\r\n\t\tvar afterEl = direction > 0 ? replies.last() : replies.first();\r\n\t\tvar after = parseInt(afterEl.attr('data-index'), 10) || 0;\r\n\r\n\t\tvar tid = ajaxify.data.tid;\r\n\t\tif (!utils.isNumber(tid) || !utils.isNumber(after) || (direction < 0 && components.get('post', 'index', 0).length)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar indicatorEl = $('.loading-indicator');\r\n\t\tif (!indicatorEl.is(':animated')) {\r\n\t\t\tindicatorEl.fadeIn();\r\n\t\t}\r\n\r\n\t\tinfinitescroll.loadMore('topics.loadMore', {\r\n\t\t\ttid: tid,\r\n\t\t\tafter: after,\r\n\t\t\tcount: config.postsPerPage,\r\n\t\t\tdirection: direction,\r\n\t\t\ttopicPostSort: config.topicPostSort,\r\n\t\t}, function (data, done) {\r\n\t\t\tindicatorEl.fadeOut();\r\n\r\n\t\t\tif (data && data.posts && data.posts.length) {\r\n\t\t\t\tcreateNewPosts(data, replies, direction, done);\r\n\t\t\t} else {\r\n\t\t\t\tnavigator.update();\r\n\t\t\t\tdone();\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tPosts.processPage = function (posts) {\r\n\t\timages.unloadImages(posts);\r\n\t\tPosts.showBottomPostBar();\r\n\t\tposts.find('[component=\"post/content\"] img:not(.not-responsive)').addClass('img-responsive');\r\n\t\tapp.createUserTooltips(posts);\r\n\t\tapp.replaceSelfLinks(posts.find('a'));\r\n\t\tutils.addCommasToNumbers(posts.find('.formatted-number'));\r\n\t\tutils.makeNumbersHumanReadable(posts.find('.human-readable-number'));\r\n\t\tposts.find('.timeago').timeago();\r\n\r\n\t\taddBlockquoteEllipses(posts.find('[component=\"post/content\"] > blockquote > blockquote'));\r\n\t\thidePostToolsForDeletedPosts(posts);\r\n\t};\r\n\r\n\tPosts.showBottomPostBar = function () {\r\n\t\tvar mainPost = components.get('post', 'index', 0);\r\n\t\tvar placeHolder = $('.post-bar-placeholder');\r\n\t\tvar posts = $('[component=\"post\"]');\r\n\t\tif (!!mainPost.length && posts.length > 1 && $('.post-bar').length < 2 && placeHolder.length) {\r\n\t\t\t$('.post-bar').clone().insertAfter(placeHolder);\r\n\t\t\tplaceHolder.remove();\r\n\t\t} else if (mainPost.length && posts.length < 2) {\r\n\t\t\tmainPost.find('.post-bar').remove();\r\n\t\t}\r\n\t};\r\n\r\n\tfunction hidePostToolsForDeletedPosts(posts) {\r\n\t\tposts.each(function () {\r\n\t\t\tif ($(this).hasClass('deleted')) {\r\n\t\t\t\tpostTools.toggle($(this).attr('data-pid'), true);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction addBlockquoteEllipses(blockquotes) {\r\n\t\tblockquotes.each(function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tif ($this.find(':hidden:not(br)').length && !$this.find('.toggle').length) {\r\n\t\t\t\t$this.append('<i class=\"fa fa-angle-down pointer toggle\"></i>');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\treturn Posts;\r\n});\r\n"]}